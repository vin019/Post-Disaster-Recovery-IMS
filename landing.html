<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDRIMS - Viewer Access Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#004D40',
                        'primary-deep': '#00382E',
                        'primary-light': '#00796B',
                        'aid-color': '#A27500',

                        'mgm-dark': '#800000',
                        'mgm-deep': '#630000',
                        'mgm-light': '#A52A2A',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f7f7;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #bdbdbd;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        .hero-section {
            background-image: linear-gradient(rgba(0, 77, 64, 0.85), rgba(0, 121, 107, 0.75)), url('disaster.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
            transition: background-image 0.5s ease;
        }

        .hero-management-mode {
            background-image: linear-gradient(rgba(128, 0, 0, 0.85), rgba(165, 42, 42, 0.75)), url('disaster.png');
        }

        .modal {
            transition: opacity 0.1s linear, visibility 0.1s linear;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
        }

        .modal-open {
            overflow: hidden;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <header class="bg-white shadow-md sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center">
                    <i data-lucide="shield-check" class="w-7 h-7 text-primary-dark mr-2"></i>
                    <span class="text-xl font-extrabold text-primary-dark tracking-tight">PDRIMS</span>

                    <button id="accessToggleButton"
                        class="hidden sm:flex items-center text-sm font-medium text-gray-500 ml-2 pl-2 border-l border-gray-300 group"
                        data-mode="viewer">
                        <span id="accessToggleText">Viewer Access</span>
                    </button>
                </div>

                <nav class="flex items-center space-x-3">
                    <button id="loginButton"
                        class="flex items-center text-primary-dark font-medium px-4 py-2 rounded-lg border-2 border-transparent hover:border-primary-light transition duration-150">
                        <i data-lucide="log-in" class="w-4 h-4 mr-1"></i>
                        Login
                    </button>
                    <button id="signUpButton"
                        class="bg-primary-dark text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-primary-light transition duration-150 transform hover:scale-[1.02]">
                        <i data-lucide="user-plus" class="w-4 h-4 inline-block mr-1"></i>
                        Sign Up
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="flex-grow">
        <section class="hero-section py-20 sm:py-32">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-3xl sm:text-4xl lg:text-4xl font-extrabold leading-tight mb-4 tracking-wider">
                    Streamlining Recovery, From Your Barangay
                </h1>
                <p class="text-lg sm:text-xl font-light opacity-80 max-w-3xl mx-auto mb-8">
                    Access public summaries and real-time status updates on post-disaster recovery efforts in your
                    community.
                </p>
                <a href="#feature-blocks" id="heroCtaLink"
                    class="inline-flex items-center justify-center bg-white text-primary-dark font-bold text-base px-7 py-3 rounded-full shadow-xl hover:bg-gray-100 transition duration-300 transform hover:scale-105">
                    View Public Reports
                    <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
                </a>
            </div>
        </section>

        <div id="feature-blocks" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 -mt-16 sm:-mt-20 relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <div class="p-8 rounded-lg shadow-xl bg-gray-50 text-gray-900 transition duration-300 hover:shadow-2xl hover:bg-white cursor-pointer"
                    data-action="explore-damage">
                    <div class="text-5xl font-extrabold mb-3 text-primary-light">1</div>
                    <h3 class="text-xl font-bold mb-2">Household Damage Status</h3>
                    <p class="text-sm text-gray-700 mb-4">See aggregated data on the extent of damage to homes across
                        different puroks and sitios.</p>
                    <a href="#" data-action="explore-damage"
                        class="action-link mt-3 text-xs font-medium border-b border-primary-dark pb-1 text-primary-dark hover:opacity-75 inline-flex items-center">
                        Explore Data <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                    </a>
                </div>

                <div class="p-8 rounded-lg shadow-xl bg-gray-50 text-gray-900 transition duration-300 hover:shadow-2xl hover:bg-white cursor-pointer"
                    data-action="check-aid">
                    <div class="text-5xl font-extrabold mb-3 text-aid-color">2</div>
                    <h3 class="text-xl font-bold mb-2">Aid Allocation Reports</h3>
                    <p class="text-sm text-gray-700 mb-4">View transparency reports detailing the types and quantities
                        of aid distributed by date and location.</p>
                    <a href="#" data-action="check-aid"
                        class="action-link mt-3 text-xs font-medium border-b border-aid-color pb-1 text-aid-color hover:opacity-75 inline-flex items-center">
                        Check Records <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                    </a>
                </div>

                <div class="p-8 rounded-lg shadow-xl bg-gray-50 text-gray-900 transition duration-300 hover:shadow-2xl hover:bg-white cursor-pointer"
                    data-action="see-timeline">
                    <div class="text-5xl font-extrabold mb-3 text-primary-dark">3</div>
                    <h3 class="text-xl font-bold mb-2">Overall Recovery Progress</h3>
                    <p class="text-sm text-gray-700 mb-4">Monitor the barangay's overall recovery percentage based on
                        official assessments and data input.</p>
                    <a href="#" data-action="see-timeline"
                        class="action-link mt-3 text-xs font-medium border-b border-primary-dark pb-1 text-primary-dark hover:opacity-75 inline-flex items-center">
                        See Timeline <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                    </a>
                </div>

            </div>
        </div>

        <section id="managementCtaSection" class="py-16 bg-gray-100 hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">Are you a Barangay Official?</h2>
                <p class="text-lg text-gray-600 mb-6 max-w-2xl mx-auto">
                    Log in to your account to manage household profiles, record aid distribution, and generate official
                    documentation.
                </p>
                <button id="accessManagementButton"
                    class="bg-primary-dark text-white font-semibold px-6 py-3 rounded-lg shadow-lg hover:bg-primary-light transition duration-300 transform hover:translate-y-0.5">
                    <i data-lucide="lock" class="w-5 h-5 inline-block mr-2"></i> Access Management Portal
                </button>
            </div>
        </section>

    </main>

    <footer id="mainFooter" class="bg-primary-deep text-white py-12 mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="footerGrid" class="grid grid-cols-2 md:grid-cols-4 gap-8 pb-8 border-b border-white/20 mb-6">

                <div>
                    <span class="text-xl font-extrabold tracking-tight mb-2 flex items-center">
                        <i data-lucide="shield-check" class="w-6 h-6 mr-1"></i> PDRIMS
                    </span>
                    <p class="text-xs mt-2 opacity-75">
                        Post-Disaster Recovery & Information Management System. Streamlining Recovery, From Your
                        Barangay
                    </p>
                </div>

                <div>
                    <h4 class="font-semibold mb-3 text-sm tracking-wider">Data Access</h4>
                    <ul class="space-y-2 text-xs">
                        <li><a href="#" class="hover:underline opacity-80 hover:opacity-100">Damage Reports</a></li>
                        <li><a href="#" class="hover:underline opacity-80 hover:opacity-100">Aid Distribution</a></li>
                        <li><a href="#" class="hover:underline opacity-80 hover:opacity-100">Recovery Status</a></li>
                        <li><a href="#" class="hover:underline opacity-80 hover:opacity-100">Public Filings</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-semibold mb-3 text-sm tracking-wider">Legal & Support</h4>
                    <ul class="space-y-2 text-xs">
                        <li><a href="#" class="hover:underline opacity-80 hover:opacity-100">Privacy Policy</a></li>
                        <li><a href="#" class="hover:underline opacity-80 hover:opacity-100">Terms of Service</a></li>
                        <li><a href="#" class="hover:underline opacity-80 hover:opacity-100">Contact Support</a></li>
                        <li><a href="#" class="hover:underline opacity-80 hover:opacity-100">System Guide</a></li>
                    </ul>
                </div>

                <div id="footerContactColumn">
                    <h4 class="font-semibold mb-3 text-sm tracking-wider">Contact Us</h4>
                    <p class="text-xs opacity-75 leading-relaxed">
                        <span class="font-bold">Address:</span> Barangay Hall, Brgy. 45, Sta. Cruz, Tacloban City<br>
                        <span class="font-bold">Email:</span> official@pdrims.gov
                    </p>
                    <p class="text-xs mt-4 opacity-50">
                        <span class="font-bold">Disclaimer:</span> This is a functional prototype.
                    </p>
                </div>

            </div>

            <div id="footerCopyright" class="text-center text-xs opacity-60">
                <p>&copy; 2025 PDRIMS. All rights reserved. | Developed by Mojo Jojo and The Powerpuff Girls.</p>
            </div>
        </div>
    </footer>

    <div id="universalModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div id="modalContentWrapper" class="bg-white rounded-xl shadow-2xl w-full max-w-xl p-6 relative modal-content">
            <button id="closeModalButton" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <div id="modalBody">
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const universalModal = document.getElementById('universalModal');
        const modalBody = document.getElementById('modalBody');
        const closeModalButton = document.getElementById('closeModalButton');
        const loginButton = document.getElementById('loginButton');
        const signUpButton = document.getElementById('signUpButton');
        const accessManagementButton = document.getElementById('accessManagementButton');
        const heroCtaLink = document.getElementById('heroCtaLink');
        const mainFooter = document.getElementById('mainFooter');
        const featureLinks = document.querySelectorAll('.action-link');
        const featureBlocks = document.querySelectorAll('[data-action]');
        const accessToggleButton = document.getElementById('accessToggleButton');
        const managementCtaSection = document.getElementById('managementCtaSection');
        const modalContentWrapper = document.getElementById('modalContentWrapper');
        const heroSection = document.querySelector('.hero-section');

        const VIEWER_CLASSES = {
            login: ['text-primary-dark', 'hover:border-primary-light'],
            signup: ['bg-primary-dark', 'hover:bg-primary-light'],
            ctaText: ['text-primary-dark'],
            footer: ['bg-primary-deep'],
        };
        const MANAGEMENT_CLASSES = {
            login: ['text-mgm-dark', 'hover:border-mgm-light'],
            signup: ['bg-mgm-dark', 'hover:bg-mgm-light'],
            ctaText: ['text-mgm-dark'],
            footer: ['bg-mgm-deep'],
        };

        let currentAccessMode = 'viewer';
        let signupData = {};

        function toggleModeStyles(toMode) {
            const isManagement = toMode === 'management';
            const from = isManagement ? VIEWER_CLASSES : MANAGEMENT_CLASSES;
            const to = isManagement ? MANAGEMENT_CLASSES : VIEWER_CLASSES;

            loginButton.classList.remove(...from.login);
            loginButton.classList.add(...to.login);

            signUpButton.classList.remove(...from.signup);
            signUpButton.classList.add(...to.signup);

            heroCtaLink.classList.remove(...from.ctaText);
            heroCtaLink.classList.add(...to.ctaText);

            accessManagementButton.classList.remove(...from.signup);
            accessManagementButton.classList.add(...to.signup);

            mainFooter.classList.remove(...from.footer);
            mainFooter.classList.add(...to.footer);

        }

        function switchToViewer() {
            if (currentAccessMode === 'viewer') return;

            const text = document.getElementById('accessToggleText');
            const toggleButton = document.getElementById('accessToggleButton');

            if (text) text.textContent = 'Viewer Access';
            if (toggleButton) toggleButton.setAttribute('data-mode', 'viewer');
            document.title = 'PDRIMS - Viewer Access Portal';

            managementCtaSection.classList.add('hidden');
            heroSection.classList.remove('hero-management-mode');

            toggleModeStyles('viewer');

            currentAccessMode = 'viewer';
        }

        function switchToManagement() {
            if (currentAccessMode === 'management') return;

            const text = document.getElementById('accessToggleText');
            const toggleButton = document.getElementById('accessToggleButton');

            if (text) text.textContent = 'Management Access';
            if (toggleButton) toggleButton.setAttribute('data-mode', 'management');
            document.title = 'PDRIMS - Management Access Portal';

            managementCtaSection.classList.remove('hidden');
            heroSection.classList.add('hero-management-mode');

            toggleModeStyles('management');

            currentAccessMode = 'management';
        }

        function showModal(contentHTML, maxWidthClass = 'max-w-xl') {
            modalBody.innerHTML = contentHTML;
            document.body.classList.add('modal-open');

            const maxWClasses = ['max-w-xl', 'max-w-3xl', 'max-w-4xl', 'max-w-2xl', 'max-w-lg', 'max-w-md'];
            maxWClasses.forEach(c => modalContentWrapper.classList.remove(c));
            modalContentWrapper.classList.add(maxWidthClass);

            universalModal.classList.remove('invisible', 'opacity-0');
            universalModal.classList.add('visible', 'opacity-100');
            lucide.createIcons();
        }

        function hideModal() {
            document.body.classList.remove('modal-open');
            universalModal.classList.remove('visible', 'opacity-100');
            universalModal.classList.add('invisible', 'opacity-0');
            modalBody.innerHTML = '';
        }

        closeModalButton.addEventListener('click', hideModal);
        universalModal.addEventListener('click', (e) => {
            if (e.target === universalModal) {
                hideModal();
            }
        });

        function getPurokQuestionModal() {
            return `
                <h2 class="text-2xl font-bold text-primary-dark mb-2">Community Registration</h2>
                <p class="text-sm text-gray-500 mb-6">Are you a registered resident and member of this Purok?</p>
                <div class="space-y-4">
                    <button onclick="showSignupForm(true)" class="w-full flex items-center justify-center bg-primary-dark text-white font-semibold py-3 rounded-lg shadow-md hover:bg-primary-light transition duration-150 transform hover:scale-[1.01]">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> Yes, I am a member
                    </button>
                    <button onclick="showSignupForm(false)" class="w-full flex items-center justify-center bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg shadow-md hover:bg-gray-300 transition duration-150 transform hover:scale-[1.01]">
                        <i data-lucide="x-circle" class="w-5 h-5 mr-2"></i> No, I am not a member
                    </button>
                </div>
                <p class="mt-6 text-center text-sm text-gray-500 cursor-pointer hover:text-primary-dark" onclick="toggleAuthModal('Login')">
                    Already registered? Login
                </p>
            `;
        }

        function getSignupStep1FormModal(isMember) {
            const title = isMember ? 'Purok Member Registration (Step 1 of 2)' : 'General Viewer Registration (Step 1 of 2)';
            const subtitle = isMember ? 'Please complete your household and personal details.' : 'Enter your basic contact details.';
            const getVal = (key) => signupData[key] || '';
            const getChecked = (key) => signupData[key] ? 'checked' : '';

            const buttonBg = currentAccessMode === 'management' ? 'bg-mgm-dark hover:bg-mgm-light' : 'bg-primary-dark hover:bg-primary-light';
            const textColor = currentAccessMode === 'management' ? 'text-mgm-dark' : 'text-primary-dark';
            const focusRing = currentAccessMode === 'management' ? 'focus:ring-mgm-light focus:border-mgm-light' : 'focus:ring-primary-light focus:border-primary-light';


            const memberFields = isMember ? `
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-1 mb-4"><label for="purok" class="block text-sm font-medium text-gray-700 mb-1">Purok/Sitio</label><input type="text" id="purok" name="purok" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" placeholder="e.g., Purok 3" required value="${getVal('purok')}"></div>
                    <div class="col-span-1 mb-4"><label for="contact" class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label><input type="tel" id="contact" name="contact" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" placeholder="e.g., 09123456789" required value="${getVal('contact')}"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                     <div class="col-span-1 mb-4"><label for="age" class="block text-sm font-medium text-gray-700 mb-1">Age</label><input type="number" id="age" name="age" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" min="12" max="120" required value="${getVal('age')}"></div>
                    <div class="col-span-1 mb-4"><label for="householdHead" class="block text-sm font-medium text-gray-700 mb-1">Household Head</label><input type="text" id="householdHead" name="householdHead" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" placeholder="Name of Household Head" required value="${getVal('householdHead')}"></div>
                </div>
                <div class="flex items-center mb-6"><input id="isHead" name="isHead" type="checkbox" class="h-4 w-4 ${textColor.replace('text-', 'text-')} border-gray-300 rounded ${focusRing}" ${getChecked('isHead')}><label for="isHead" class="ml-2 block text-sm text-gray-900">I am the Head of the Household</label></div>
            ` : `
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-1 mb-4"><label for="contact" class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label><input type="tel" id="contact" name="contact" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" placeholder="e.g., 09123456789" required value="${getVal('contact')}"></div>
                    <div class="col-span-1 mb-4"><label for="age" class="block text-sm font-medium text-gray-700 mb-1">Age</label><input type="number" id="age" name="age" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" min="12" max="120" required value="${getVal('age')}"></div>
                </div>
            `;

            const commonFields = `
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div class="col-span-1"><label for="surname" class="block text-sm font-medium text-gray-700 mb-1">Surname</label><input type="text" id="surname" name="surname" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" required value="${getVal('surname')}"></div>
                    <div class="col-span-1"><label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">First Name</label><input type="text" id="firstName" name="firstName" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" required value="${getVal('firstName')}"></div>
                    <div class="col-span-1"><label for="middleInitial" class="block text-sm font-medium text-gray-700 mb-1">M.I.</label><input type="text" id="middleInitial" name="middleInitial" maxlength="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" required value="${getVal('middleInitial')}"></div>
                </div>
            `;

            return `
                <h2 class="text-2xl font-bold ${textColor} mb-2">${title}</h2>
                <p class="text-sm text-gray-500 mb-6">${subtitle}</p>
                <form onsubmit="handleStep1Submit(event, ${isMember})">
                    ${commonFields}
                    ${memberFields}
                    <button type="submit" class="w-full ${buttonBg} text-white font-semibold py-2.5 rounded-lg shadow-md transition duration-150">
                        Next <i data-lucide="arrow-right" class="w-4 h-4 inline-block ml-1"></i>
                    </button>
                    <p class="mt-4 text-center text-sm text-gray-500 cursor-pointer hover:text-primary-dark" onclick="toggleAuthModal('Login')">Already registered? Login</p>
                    <p class="mt-2 text-center text-xs text-gray-400 cursor-pointer hover:text-primary-light" onclick="showPurokMembershipQuestion()">
                        <i data-lucide="arrow-left" class="w-3 h-3 inline-block"></i> Back to Membership Question
                    </p>
                </form>
            `;
        }

        function getSignupStep2FormModal(isMember) {
            const title = isMember ? 'Purok Member Registration (Step 2 of 2)' : 'General Viewer Registration (Step 2 of 2)';
            const subtitle = 'Create your secure login credentials.';
            const getVal = (key) => signupData[key] || '';

            const buttonBg = currentAccessMode === 'management' ? 'bg-mgm-dark hover:bg-mgm-light' : 'bg-primary-dark hover:bg-primary-light';
            const textColor = currentAccessMode === 'management' ? 'text-mgm-dark' : 'text-primary-dark';
            const focusRing = currentAccessMode === 'management' ? 'focus:ring-mgm-light focus:border-mgm-light' : 'focus:ring-primary-light focus:border-primary-light';


            return `
                <h2 class="text-2xl font-bold ${textColor} mb-2">${title}</h2>
                <p class="text-sm text-gray-500 mb-6">${subtitle}</p>
                <form onsubmit="handleStep2Submit(event, ${isMember})">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" placeholder="you@example.com" required value="${getVal('email')}">
                    </div>
                    <div class="mb-4">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" placeholder="••••••••" required>
                    </div>
                    <div class="mb-6">
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" placeholder="••••••••" required>
                    </div>
                    
                    <div class="flex justify-between space-x-4">
                        <button type="button" onclick="showSignupStep1(${isMember})" class="flex-1 flex items-center justify-center bg-gray-200 text-gray-800 font-semibold py-2.5 rounded-lg shadow-md hover:bg-gray-300 transition duration-150">
                            <i data-lucide="arrow-left" class="w-4 h-4 inline-block mr-1"></i> Previous
                        </button>
                        <button type="submit" class="flex-1 ${buttonBg} text-white font-semibold py-2.5 rounded-lg shadow-md transition duration-150">
                            Sign Up
                        </button>
                    </div>
                </form>
                <p class="mt-4 text-center text-sm text-gray-500 cursor-pointer hover:text-primary-dark" onclick="toggleAuthModal('Login')">
                    Already registered? Login
                </p>
            `;
        }

        function getUserAuthModal(type) {
            const isLogin = type === 'Login';
            const title = isLogin ? 'Viewer Login' : 'Create Viewer Account';
            const subtitle = isLogin ? 'Access your personal recovery updates.' : 'Join your community in recovery efforts.';
            const submitText = isLogin ? 'Login Securely' : 'Continue to Sign Up';
            const linkText = isLogin ? 'Need an account? Sign Up' : 'Already registered? Login';

            const buttonBg = currentAccessMode === 'management' ? 'bg-mgm-dark hover:bg-mgm-light' : 'bg-primary-dark hover:bg-primary-light';
            const textColor = currentAccessMode === 'management' ? 'text-mgm-dark' : 'text-primary-dark';
            const focusRing = currentAccessMode === 'management' ? 'focus:ring-mgm-light focus:border-mgm-light' : 'focus:ring-primary-light focus:border-primary-light';


            if (isLogin) {
                return `
                    <h2 class="text-2xl font-bold ${textColor} mb-2">${title}</h2>
                    <p class="text-sm text-gray-500 mb-6">${subtitle}</p>
                    <form onsubmit="handleAuthSubmit(event, 'Login')">
                        <div class="mb-4">
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" placeholder="you@example.com" required>
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" placeholder="••••••••" required>
                        </div>
                        <button type="submit" class="w-full ${buttonBg} text-white font-semibold py-2.5 rounded-lg shadow-md transition duration-150">
                            ${submitText}
                        </button>
                        <p class="mt-4 text-center text-sm text-gray-500 cursor-pointer hover:text-primary-dark" onclick="showPurokMembershipQuestion()">
                            ${linkText}
                        </p>
                    </form>
                `;
            }

            return getPurokQuestionModal();
        }

        function getManagementPortalModal() {
            return `
                <h2 class="text-2xl font-bold text-aid-color mb-2">Management Portal Access</h2>
                <p class="text-sm text-gray-500 mb-6">Barangay Officials: Please enter your verified credentials.</p>
                <form onsubmit="handleManagementSubmit(event)">
                    <div class="mb-4">
                        <label for="officialId" class="block text-sm font-medium text-gray-700 mb-1">Official Email Address</label>
                        <input type="email" id="officialId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-aid-color focus:border-aid-color transition" placeholder="official@barangay.gov.ph" required>
                    </div>
                    <div class="mb-4">
                        <label for="officialPin" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="officialPin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-aid-color focus:border-aid-color transition" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="w-full bg-aid-color text-white font-semibold py-2.5 rounded-lg shadow-md hover:bg-aid-color/90 transition duration-150">
                        Secure Login
                    </button>
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <p class="text-center text-sm text-gray-500 mb-3">Don't have an account?</p>
                        <button type="button" onclick="showRequestAccountModal()" class="w-full text-sm text-primary-dark font-medium py-2 rounded-lg border-2 border-primary-dark hover:bg-primary-dark hover:text-white transition duration-150">
                            Request Account (Admin Approval)
                        </button>
                    </div>
                </form>
            `;
        }

        function loginUser(username, password) {
            // Use relative path to avoid port issues
            return fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
                .then(res => {
                    if (!res.ok) return res.json().then(err => { throw new Error(err.error || 'Login failed') });
                    return res.json();
                });
        }

        function handleFormSubmit(event, formName) {
            event.preventDefault();

            if (formName.includes('Authentication') || formName.includes('Management ID Verification')) {
                const isManagement = formName.includes('Management ID Verification');
                const usernameInput = isManagement ? document.getElementById('officialId') : document.getElementById('email');
                const passwordInput = isManagement ? document.getElementById('officialPin') : document.getElementById('password');

                const username = usernameInput ? usernameInput.value : '';
                const password = passwordInput ? passwordInput.value : '';

                if (!username || !password) {
                    alertMessage("Please enter both email and password.", "error");
                    return;
                }

                loginUser(username, password)
                    .then(data => {
                        console.log("Login Success:", data);
                        sessionStorage.setItem('currentUser', JSON.stringify(data));

                        if (data.role === 'admin') {
                            window.location.href = 'admin.html';
                        } else if (data.role === 'official') {
                            if (data.verified) {
                                window.location.href = 'official.html'; // Ensure this file exists!
                            } else {
                                alertMessage("Your account is pending admin verification.", "info");
                            }
                        } else {
                            // Viewer Mode
                            hideModal();
                            switchToViewer();
                            // Visual feedback
                            const loginBtn = document.getElementById('loginButton');
                            if (loginBtn) {
                                // Fallback if data.name is missing (server mismatch)
                                const displayName = data.name || `${data.surname}, ${data.first_name}`;
                                loginBtn.innerHTML = '<i data-lucide="user" class="w-4 h-4 mr-1"></i> ' + displayName.split(',')[0];
                                loginBtn.onclick = null; // Disable click or make it logout
                            }
                            document.getElementById('signUpButton').style.display = 'none';
                            alertMessage(`Welcome back, ${data.name}!`, "info");
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alertMessage(err.message, "error");
                    });
                return;
            }
        }

        function getRequestAccountModal() {
            const buttonBg = currentAccessMode === 'management' ? 'bg-mgm-dark hover:bg-mgm-light' : 'bg-primary-dark hover:bg-primary-light';
            const textColor = currentAccessMode === 'management' ? 'text-mgm-light' : 'text-primary-light';
            const focusRing = currentAccessMode === 'management' ? 'focus:ring-mgm-light focus:border-mgm-light' : 'focus:ring-primary-light focus:border-primary-light';

            return `
                <h2 class="text-2xl font-bold ${textColor} mb-2">Request Official Account</h2>
                <p class="text-sm text-gray-500 mb-6">Please fill out the form for admin approval. Verification may take 2-3 business days.</p>
                <form onsubmit="handleRequestSubmit(event)">
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="name" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" required>
                    </div>
                    <div class="mb-4">
                        <label for="barangay" class="block text-sm font-medium text-gray-700 mb-1">Barangay Name</label>
                        <input type="text" id="barangay" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" required>
                    </div>
                    <div class="mb-6">
                        <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Official Role</label>
                        <input type="text" id="role" class="w-full px-3 py-2 border border-gray-300 rounded-lg ${focusRing} transition" required>
                    </div>
                    <button type="submit" class="w-full ${buttonBg} text-white font-semibold py-2.5 rounded-lg shadow-md transition duration-150">
                        Submit Request
                    </button>
                    <p class="mt-4 text-center text-sm text-gray-500 cursor-pointer hover:text-primary-dark" onclick="showManagementPortalModal()">
                        <i data-lucide="arrow-left" class="w-4 h-4 inline-block mr-1"></i> Back to Login
                    </p>
                </form>
            `;
        }

        function toggleAuthModal(type) {
            if (type === 'Sign Up') {
                showPurokMembershipQuestion();
            } else {
                showModal(getUserAuthModal(type));
            }
        }

        function showPurokMembershipQuestion() {
            showModal(getPurokQuestionModal());
        }

        function showSignupForm(isMember) {
            signupData = {};
            showSignupStep1(isMember);
        }

        function showSignupStep1(isMember) {
            showModal(getSignupStep1FormModal(isMember), 'max-w-3xl');
        }

        function showSignupStep2(isMember) {
            showModal(getSignupStep2FormModal(isMember), 'max-w-xl');
        }

        function showManagementPortalModal() {
            showModal(getManagementPortalModal());
        }

        function showRequestAccountModal() {
            showModal(getRequestAccountModal());
        }

        loginButton.addEventListener('click', () => toggleAuthModal('Login'));
        signUpButton.addEventListener('click', () => toggleAuthModal('Sign Up'));

        if (accessToggleButton) {
            accessToggleButton.addEventListener('click', () => {
                if (currentAccessMode === 'viewer') {
                    switchToManagement();
                } else {
                    switchToViewer();
                }
            });
        }

        if (accessManagementButton) {
            accessManagementButton.addEventListener('click', showManagementPortalModal);
        }

        // --- PUBLIC DATA & REPORTS LOGIC ---

        async function fetchPublicData() {
            try {
                const [householdsRes, aidRes] = await Promise.all([
                    fetch('/api/households'),
                    fetch('/api/aid-records')
                ]);

                const households = await householdsRes.json();
                const aidRecords = await aidRes.json();

                return { households, aidRecords };
            } catch (error) {
                console.error("Error fetching public data:", error);
                alertMessage("Unable to load public reports at this time.", "error");
                return { households: [], aidRecords: [] };
            }
        }

        async function renderDamageModal() {
            showModal(`
                <h2 class="text-2xl font-bold text-primary-dark mb-4">Household Damage Status</h2>
                <div class="animate-pulse flex space-x-4"><div class="flex-1 space-y-4 py-1"><div class="h-4 bg-gray-200 rounded w-3/4"></div><div class="space-y-2"><div class="h-4 bg-gray-200 rounded"></div><div class="h-4 bg-gray-200 rounded w-5/6"></div></div></div></div>
            `);

            const { households } = await fetchPublicData();

            // calculate counts
            // Normalize purok strings to avoid case/spacing issues if any
            const cleanPurok = (p) => (p || '').trim();
            const p1 = households.filter(h => cleanPurok(h.purok) === 'Purok 1').length;
            const p2 = households.filter(h => cleanPurok(h.purok) === 'Purok 2').length;
            const p3 = households.filter(h => cleanPurok(h.purok) === 'Purok 3').length;

            const max = Math.max(p1, p2, p3, 1); // Avoid div by zero

            // Helper to create a bar
            const createBar = (label, count, colorClass) => {
                const width = Math.max((count / max) * 100, 5); // Min 5% width for visibility
                return `
                    <div class="mb-4">
                        <div class="flex justify-between text-sm font-medium text-gray-700 mb-1">
                            <span>${label}</span>
                            <span class="font-bold">${count}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="${colorClass} h-4 rounded-full transition-all duration-1000 ease-out" style="width: ${width}%"></div>
                        </div>
                    </div>
                `;
            };

            const content = `
                <h2 class="text-2xl font-bold text-primary-dark mb-2">Household Damage Status</h2>
                <p class="text-sm text-gray-500 mb-6">Aggregated damage reports per Purok/Sitio.</p>
                
                <div class="mt-4 p-4 bg-white rounded-lg border border-gray-100 shadow-sm">
                    ${createBar('Purok 1', p1, 'bg-primary-dark')}
                    ${createBar('Purok 2', p2, 'bg-primary-light')}
                    ${createBar('Purok 3', p3, 'bg-aid-color')}
                </div>

                <div class="mt-6 flex justify-end">
                    <button onclick="hideModal()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Close</button>
                </div>
            `;
            showModal(content, 'max-w-xl');
            lucide.createIcons();
        }

        async function renderAidModal() {
            showModal(`
                <h2 class="text-2xl font-bold text-aid-color mb-4">Aid Allocation Reports</h2>
                <div class="animate-pulse flex space-x-4"><div class="flex-1 space-y-4 py-1"><div class="h-4 bg-gray-200 rounded w-3/4"></div><div class="space-y-2"><div class="h-4 bg-gray-200 rounded"></div></div></div></div>
            `);

            const { aidRecords } = await fetchPublicData();

            // Simple aggregate
            const totalItems = aidRecords.reduce((sum, r) => sum + parseInt(r.quantity || 0), 0);
            const recent = aidRecords.sort((a, b) => new Date(b.date_distributed) - new Date(a.date_distributed)).slice(0, 5);

            const rows = recent.map(r => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4 text-sm font-medium text-gray-800">${r.aid_type}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${r.quantity}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${r.date_distributed}</td>
                    <td class="py-3 px-4 text-sm text-gray-500 text-right text-xs">ID: ***${String(r.recipient_id).slice(-4)}</td>
                </tr>
            `).join('');

            const content = `
                <h2 class="text-2xl font-bold text-aid-color mb-2">Aid Allocation Reports</h2>
                <p class="text-sm text-gray-500 mb-6">Transparency report on recent distributions.</p>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                        <p class="text-xs text-orange-800 uppercase font-semibold">Total Aid Distributed</p>
                        <p class="text-3xl font-bold text-aid-color mt-1">${totalItems}</p>
                        <p class="text-xs text-orange-600 mt-1">Units (All Types)</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <p class="text-xs text-blue-800 uppercase font-semibold">Distributions Recorded</p>
                        <p class="text-3xl font-bold text-blue-700 mt-1">${aidRecords.length}</p>
                        <p class="text-xs text-blue-600 mt-1">Transactions</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="py-2 px-4 text-left text-xs font-semibold text-gray-500 uppercase">Type</th>
                                <th class="py-2 px-4 text-left text-xs font-semibold text-gray-500 uppercase">Qty</th>
                                <th class="py-2 px-4 text-left text-xs font-semibold text-gray-500 uppercase">Date</th>
                                <th class="py-2 px-4 text-right text-xs font-semibold text-gray-500 uppercase">Ref</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.length ? rows : '<tr><td colspan="4" class="p-4 text-center text-sm text-gray-500">No records found.</td></tr>'}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 flex justify-end">
                     <button onclick="hideModal()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Close</button>
                </div>
            `;
            showModal(content, 'max-w-2xl');
        }

        async function renderRecoveryModal() {
            showModal(`
                <h2 class="text-2xl font-bold text-primary-dark mb-4">Overall Recovery Progress</h2>
                <div class="animate-pulse flex space-x-4"><div class="flex-1 space-y-4 py-1"><div class="h-4 bg-gray-200 rounded w-3/4"></div><div class="space-y-2"><div class="h-4 bg-gray-200 rounded"></div></div></div></div>
            `);

            const { households, aidRecords } = await fetchPublicData();

            const total = households.length;
            const recipientIds = new Set(aidRecords.map(r => r.recipient_id));
            const recoveredCount = recipientIds.size; // "Recovered" = Received at least some aid

            const percentage = total > 0 ? Math.round((recoveredCount / total) * 100) : 0;

            const content = `
                <h2 class="text-2xl font-bold text-primary-dark mb-2">Overall Recovery Progress</h2>
                <p class="text-sm text-gray-500 mb-8">Barangay-wide recovery status based on aid coverage.</p>

                 <div class="flex justify-center items-center h-56 relative mb-8">
                    <!-- Donut Chart Container -->
                    <div class="w-48 h-48 rounded-full bg-gray-200 relative shadow-xl"
                        style="background: conic-gradient(#00796B ${percentage}%, #e5e7eb 0);">
                        <!-- Inner Circle -->
                        <div class="absolute inset-4 bg-white rounded-full flex flex-col items-center justify-center shadow-inner">
                            <p class="text-5xl font-extrabold text-primary-dark tracking-tighter">
                                ${percentage}%
                            </p>
                            <p class="text-xs text-gray-500 font-medium uppercase tracking-wide mt-1">Recovered</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 text-center">
                     <div>
                        <p class="text-2xl font-bold text-gray-800">${recoveredCount}</p>
                        <p class="text-xs text-gray-500 uppercase">Households Aided</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-gray-800">${total}</p>
                        <p class="text-xs text-gray-500 uppercase">Total Affected</p>
                    </div>
                </div>

                 <div class="mt-8 flex justify-end">
                     <button onclick="hideModal()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Close</button>
                </div>
            `;
            showModal(content);
        }

        // Connect Feature Cards
        const handleCardClick = (action) => {
            const user = sessionStorage.getItem('currentUser');
            if (!user) {
                // Not Logged In
                alertMessage("Restricted Access: You must be logged in to view official reports.", "info");
                toggleAuthModal('Login');
                return;
            }

            if (action === 'explore-damage') renderDamageModal();
            else if (action === 'check-aid') renderAidModal();
            else if (action === 'see-timeline') renderRecoveryModal();
        };

        featureLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation(); // Stop bubbling
                handleCardClick(this.getAttribute('data-action'));
            });
        });

        featureBlocks.forEach(block => {
            block.addEventListener('click', function (e) {
                if (e.target.tagName.toLowerCase() === 'a' || e.target.closest('.action-link')) return;
                handleCardClick(this.getAttribute('data-action'));
            });
        });

        function handleStep1Submit(event, isMember) {
            event.preventDefault();
            const form = event.target;

            signupData = {
                isMember: isMember,
                surname: form.surname.value,
                firstName: form.firstName.value,
                middleInitial: form.middleInitial.value,
                contact: form.contact.value,
                age: form.age.value,
            };

            if (isMember) {
                const isHead = form.isHead.checked;
                const householdHead = form.householdHead.value;

                if (!isHead && !householdHead.trim()) {
                    console.error("As a non-head member, you must indicate the Household Head's name.");
                    alertMessage("As a non-head member, you must indicate the Household Head's name.", "error");
                    return;
                }

                signupData.purok = form.purok.value;
                signupData.isHead = isHead;
                signupData.householdHead = householdHead;
            }

            showSignupStep2(isMember);
        }

        function handleStep2Submit(event, isMember) {
            event.preventDefault();
            const form = event.target;

            const password = form.password.value;
            const confirmPassword = form.confirmPassword.value;

            if (password !== confirmPassword) {
                alertMessage("Passwords do not match.", "error");
                return;
            }

            signupData.email = form.email.value;
            signupData.password = password;

            // Prepare Payload
            // Prepare Payload to EXACTLY match Database Columns:
            // id, surname, first_name, middle_initial, email, password_hash (server handles), contact_number, age, purok, household_head, is_head, role
            const newUser = {
                surname: signupData.surname,
                first_name: signupData.firstName,
                middle_initial: signupData.middleInitial,
                email: signupData.email,
                password: signupData.password,
                contact_number: signupData.contact,
                age: signupData.age,
                purok: signupData.purok || null,
                household_head: signupData.householdHead || null,
                is_head: signupData.isHead ? 1 : 0,
                role: 'viewer'
            };

            // Send to Real Database
            fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newUser)
            })
                .then(res => {
                    if (!res.ok) return res.json().then(err => { throw new Error(err.error || 'Registration failed') });
                    return res.json();
                })
                .then(data => {
                    signupData = {};
                    hideModal();
                    showModal(`
                    <h2 class="text-2xl font-bold text-green-600 mb-2">Registration Successful!</h2>
                    <p class="text-sm text-gray-500 mb-4">Your account has been created.</p>
                    <button onclick="toggleAuthModal('Login')" class="mt-6 w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700 transition">
                        Go to Login
                    </button>
                `);
                })
                .catch(err => {
                    alertMessage("Registration Failed: " + err.message, "error");
                });
        }

        function alertMessage(message, type = 'info') {
            const colors = {
                info: { bg: 'bg-blue-50', border: 'border-blue-500', text: 'text-blue-800' },
                error: { bg: 'bg-red-50', border: 'border-red-500', text: 'text-red-800' }
            };
            const style = colors[type];
            showModal(`
                <h2 class="text-2xl font-bold ${style.text} mb-2">${type === 'error' ? 'Error' : 'Notification'}</h2>
                <p class="text-sm text-gray-500 mb-4">Please correct the following:</p>
                <div class="p-4 ${style.bg} rounded-lg border-l-4 ${style.border}">
                    <p class="${style.text}">${message}</p>
                </div>
                <button onclick="hideModal()" class="mt-6 w-full bg-gray-500 text-white font-semibold py-2 rounded-lg hover:bg-gray-600 transition">
                    Dismiss
                </button>
            `);
        }


        window.handleAuthSubmit = (event, type) => handleFormSubmit(event, type + ' Authentication');
        window.handleManagementSubmit = (event) => handleFormSubmit(event, 'Management ID Verification');
        window.handleRequestSubmit = (event) => handleFormSubmit(event, 'Account Request for Admin Approval');
        window.handleStep1Submit = handleStep1Submit;
        window.handleStep2Submit = handleStep2Submit;
        window.toggleAuthModal = toggleAuthModal;
        window.showManagementPortalModal = showManagementPortalModal;
        window.showRequestAccountModal = showRequestAccountModal;
        window.showPurokMembershipQuestion = showPurokMembershipQuestion;
        window.showSignupForm = showSignupForm;
        window.showSignupStep1 = showSignupStep1;
        window.showSignupStep2 = showSignupStep2;
        window.hideModal = hideModal;
        window.switchToManagement = switchToManagement;
        window.switchToViewer = switchToViewer;
        window.alertMessage = alertMessage;

    </script>
</body>

</html>